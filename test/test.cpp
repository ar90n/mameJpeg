#include <cstdlib>

#define CATCH_CONFIG_MAIN
#include "catch.hpp"

#include "../mameJpeg.h"
#include "../../mameBitmap/mameBitmap.h"

const uint8_t jpeg_blob[] = {
0xff,0xd8,0xff,0xe0,0x00,0x10,0x4a,0x46,0x49,0x46,0x00,0x01,0x01,0x01,0x00,0x48,
0x00,0x48,0x00,0x00,0xff,0xfe,0x00,0x13,0x43,0x72,0x65,0x61,0x74,0x65,0x64,0x20,
0x77,0x69,0x74,0x68,0x20,0x47,0x49,0x4d,0x50,0xff,0xdb,0x00,0x43,0x00,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xff,0xdb,
0x00,0x43,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0xff,0xc0,0x00,0x11,0x08,0x00,0x10,0x00,0x10,0x03,0x01,0x11,0x00,
0x02,0x11,0x01,0x03,0x11,0x01,0xff,0xc4,0x00,0x15,0x00,0x01,0x01,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0x0b,0xff,0xc4,0x00,
0x14,0x10,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xff,0xc4,0x00,0x14,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xc4,0x00,0x14,0x11,0x01,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,
0xda,0x00,0x0c,0x03,0x01,0x00,0x02,0x11,0x03,0x11,0x00,0x3f,0x00,0x9f,0xf8,0x10,
0x00,0x1f,0xc0,0x10,0x00,0x3f,0xff,0xd9 };

uint8_t jpeg_test_pattern[] = {
0xff,0xd8,0xff,0xe0,0x00,0x10,0x4a,0x46,0x49,0x46,0x00,0x01,0x01,0x01,0x00,0x48,0x00,0x48,0x00,0x00,0xff,0xdb,0x00,0x43,0x00,0x03,0x02,0x02,0x03,0x02,0x02,0x03,
0x03,0x03,0x03,0x04,0x03,0x03,0x04,0x05,0x08,0x05,0x05,0x04,0x04,0x05,0x0a,0x07,0x07,0x06,0x08,0x0c,0x0a,0x0c,0x0c,0x0b,0x0a,0x0b,0x0b,0x0d,0x0e,0x12,0x10,0x0d,
0x0e,0x11,0x0e,0x0b,0x0b,0x10,0x16,0x10,0x11,0x13,0x14,0x15,0x15,0x15,0x0c,0x0f,0x17,0x18,0x16,0x14,0x18,0x12,0x14,0x15,0x14,0xff,0xc0,0x00,0x0b,0x08,0x00,0x10,
0x00,0x10,0x01,0x01,0x11,0x00,0xff,0xc4,0x00,0x15,0x00,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xff,0xc4,0x00,
0x2b,0x10,0x00,0x00,0x03,0x02,0x0c,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0x14,0x15,0x00,0x12,0x09,0x17,0x19,0x22,0x26,0x35,0x39,0x42,0x64,
0x67,0x85,0x94,0x44,0x47,0x62,0x84,0xa6,0xc4,0xe4,0xff,0xda,0x00,0x08,0x01,0x01,0x00,0x00,0x3f,0x00,0x96,0x2e,0x67,0x14,0x65,0x68,0x69,0xc9,0xfb,0x91,0x44,0x3f,
0xd0,0xe8,0x57,0x9e,0x9a,0xab,0xb0,0x45,0x7b,0x72,0xe1,0x6d,0x82,0x0c,0x86,0x14,0x24,0xfe,0x01,0x3e,0x8a,0xa0,0x31,0xe7,0x66,0x89,0xef,0xb2,0x43,0x1c,0xec,0xf1,
0x4f,0xb5,0xbf,0xff,0xd9 };

uint8_t jpeg_test_pattern2[] = {
0xff,0xd8,0xff,0xe0,0x00,0x10,0x4a,0x46,0x49,0x46,0x00,0x01,0x01,0x01,0x00,0x48,0x00,0x48,0x00,0x00,0xff,0xdb,0x00,0x43,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xff,0xc0,0x00,0x0b,0x08,0x00,0x10,
0x00,0x10,0x01,0x01,0x11,0x00,0xff,0xc4,0x00,0x15,0x00,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xff,0xc4,0x00,
0x29,0x10,0x00,0x00,0x03,0x03,0x0b,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x16,0x17,0x18,0x00,0x19,0x49,0x0a,0x1a,0x26,0x2a,0x36,0x3a,0x46,0x66,
0x69,0x88,0x98,0x68,0x86,0xa8,0xc8,0xe8,0xff,0xda,0x00,0x08,0x01,0x01,0x00,0x00,0x3f,0x00,0x9d,0xcb,0xad,0x49,0x9e,0x4d,0xb3,0xa2,0x61,0x1d,0x72,0x9c,0xc5,0x31,
0x55,0x3e,0x45,0x08,0x81,0x71,0x38,0x9e,0x8f,0x2c,0xf6,0x58,0x0c,0x76,0x28,0x44,0x0b,0xc5,0x82,0xe8,0xba,0x4b,0x1d,0x1d,0x13,0x08,0xea,0x1b,0x2e,0xd9,0xa9,0x74,
0x90,0xc7,0x14,0x5d,0x93,0x7b,0x70,0xc9,0x8c,0x7a,0xa2,0xf8,0x4d,0xf5,0xc3,0x7f,0xff,0xd9};

uint8_t simple_jpeg_pattern[] = {
0xff,0xd8,0xff,0xe0,0x00,0x10,0x4a,0x46,0x49,0x46,0x00,0x01,0x01,0x01,0x00,0x48,0x00,0x48,0x00,0x00,0xff,0xdb,0x00,0x43,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xff,0xc0,0x00,0x0b,0x08,0x00,0x08,
0x00,0x08,0x01,0x01,0x11,0x00,0xff,0xc4,0x00,0x14,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xff,0xc4,0x00,0x18,
0x10,0x00,0x02,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0x49,0x88,0xc8,0xff,0xda,0x00,0x08,0x01,0x01,0x00,0x00,0x3f,0x00,
0x34,0x63,0x94,0x5a,0x4d,0xae,0x0f,0xff,0xd9 };

uint8_t simple_jpeg_pattern2[] = {
0xff,0xd8,0xff,0xe0,0x00,0x10,0x4a,0x46,0x49,0x46,0x00,0x01,0x01,0x01,0x00,0x48,0x00,0x48,0x00,0x00,0xff,0xdb,0x00,0x43,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xff,0xc0,0x00,0x0b,0x08,0x00,0x08,
0x00,0x08,0x01,0x01,0x11,0x00,0xff,0xc4,0x00,0x14,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xff,0xc4,0x00,0x18,
0x10,0x00,0x02,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0x49,0x88,0xc8,0xff,0xda,0x00,0x08,0x01,0x01,0x00,0x00,0x3f,0x00,
0x34,0x63,0x94,0x5a,0x4d,0xae,0x0f,0xff,0xd9 };

uint8_t simple_jpeg_pattern3[] = {
0xff,0xd8,0xff,0xe0,0x00,0x10,0x4a,0x46,0x49,0x46,0x00,0x01,0x01,0x01,0x00,0x48,0x00,0x48,0x00,0x00,0xff,0xdb,0x00,0x43,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xff,0xc0,0x00,0x0b,0x08,0x00,0x08,
0x00,0x08,0x01,0x01,0x11,0x00,0xff,0xc4,0x00,0x14,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xff,0xc4,0x00,0x18,
0x10,0x00,0x02,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1a,0x69,0xa8,0xe8,0xff,0xda,0x00,0x08,0x01,0x01,0x00,0x00,0x3f,0x00,
0x34,0x63,0x94,0x5a,0x4d,0xae,0x0f,0xff,0xd9 };

TEST_CASE("Bitsteram read test", "[sample]")
{
    uint8_t buffer[9] = { 0xfa, 0xab, 0x32, 0xb3, 0xf8, 0xc3, 0xaa, 0xaa, 0xbb };
    mameJpeg_memory_callback_param param = { buffer, 0, sizeof( buffer ) / sizeof( uint8_t ) };
    mameBitstream_context bitstream[1];
    mameBitstream_input_initialize( bitstream, mameJpeg_input_from_memory_callback, &param  );

    uint8_t data8 = 0;
    CHECK( mameBitstream_readBits(bitstream, &data8, 1, 1 ) );
    CHECK( data8 == 0x01 );
    CHECK( mameBitstream_readBits(bitstream, &data8, 1, 1 ) );
    CHECK( data8 == 0x01 );
    CHECK( mameBitstream_readBits(bitstream, &data8, 1, 1 ) );
    CHECK( data8 == 0x01 );
    CHECK( mameBitstream_readBits(bitstream, &data8, 1, 1 ) );
    CHECK( data8 == 0x01 );

    CHECK( mameBitstream_readBits(bitstream, &data8, 1, 3 ) );
    CHECK( data8 == 0x05 );
    CHECK( mameBitstream_readBits(bitstream, &data8, 1, 3 ) );
    CHECK( data8 == 0x02 );
  
    CHECK( mameBitstream_readBits(bitstream, &data8, 1, 8 ) );
    CHECK( data8 == 0xac );

    uint16_t data16 = 0;
    CHECK( mameBitstream_readBits(bitstream, &data16, 2, 12 ) );
    CHECK( data16 == 0xcac );
 
    uint32_t data32 = 0;
    CHECK( mameBitstream_readBits(bitstream, &data32, 4, 18 ) );
    CHECK(data32 == 0x3f8c3 );

    CHECK( mameBitstream_readBits(bitstream, &data8, 1, 8 ) );
    CHECK( data8 == 0xaa );

    CHECK( mameBitstream_readBits(bitstream, &data16, 2, 16 ) );
    CHECK( data16 == 0xaabb );

}

TEST_CASE("Bitsteram write test", "[sample]")
{
    uint8_t buffer[9];
    mameBitstream_context bitstream[1];
    mameJpeg_memory_callback_param param = { buffer, 0, sizeof( buffer ) / sizeof( uint8_t ) };
    mameBitstream_output_initialize( bitstream, mameJpeg_output_to_memory_callback, &param  );

    uint8_t data8 = 0x01;
    CHECK( mameBitstream_writeBits(bitstream, &data8, 1 ) );
    data8 = 0x01;
    CHECK( mameBitstream_writeBits(bitstream, &data8, 1 ) );
    data8 = 0x01;
    CHECK( mameBitstream_writeBits(bitstream, &data8, 1 ) );
    data8 = 0x01;
    CHECK( mameBitstream_writeBits(bitstream, &data8, 1 ) );

    data8 = 0x05;
    CHECK( mameBitstream_writeBits(bitstream, &data8, 3 ) );
    data8 = 0x02;
    CHECK( mameBitstream_writeBits(bitstream, &data8, 3 ) );
  
    data8 = 0xac;
    CHECK( mameBitstream_writeBits(bitstream, &data8, 8 ) );

    uint16_t data16 = 0xcac;
    CHECK( mameBitstream_writeBits(bitstream, &data16, 12 ) );
 
    uint32_t data32 = 0x3f8c3;
    CHECK( mameBitstream_writeBits(bitstream, &data32, 18 ) );

    data8 = 0xaa;
    CHECK( mameBitstream_writeBits(bitstream, &data8, 8 ) );
    data16 = 0xaabb;
    CHECK( mameBitstream_writeBits(bitstream, &data16, 16 ) );
    
    int res = memcmp( buffer, "\xfa\xab\x32\xb3\xf8\xc3\xaa\xaa\xbb", sizeof( buffer ) / sizeof( uint8_t ) );
    CHECK( res == 0 );
}

TEST_CASE("Get image info", "[getImageInfo]")
{
    uint16_t width;
    uint16_t height;
    uint8_t components;
    size_t work_buffer_size;
    mameJpeg_memory_callback_param input_param = { (void*)jpeg_test_pattern, 0, sizeof( jpeg_test_pattern ) / sizeof( uint8_t ) };
    mameJpeg_getImageInfo( mameJpeg_input_from_memory_callback,
                           &input_param,
                           &width,
                           &height,
                           &components,
                           &work_buffer_size );

    CHECK( width == 16 );
    CHECK( height == 16 );
    CHECK( components == 1 );
    CHECK( work_buffer_size == 320 );
}

TEST_CASE("Decode jpeg", "[sample]")
{
    uint8_t output_buffer[1024 * 1024];
    uint8_t work_buffer[1024 * 1024];
    mameJpeg_context context[1];
    mameJpeg_memory_callback_param input_param = { (void*)jpeg_test_pattern, 0, sizeof( jpeg_test_pattern ) / sizeof( uint8_t ) };
    mameJpeg_memory_callback_param output_param = { output_buffer, 0, sizeof( output_buffer ) / sizeof( uint8_t ) };
    mameJpeg_initialize( context,
                         mameJpeg_input_from_memory_callback,
                         &input_param,
                         mameJpeg_output_to_memory_callback,
                         &output_param,
                         MAMEJPEG_FORMAT_Y,
                         MAMEJPEG_DECODE );

    mameJpeg_setWorkBuffer( context, work_buffer, 1024 * 1024 );
    mameJpeg_decode( context );

    for( int y = 0; y < 16; y++ )
    {
        for( int x = 0; x < 16; x++ )
        {
            printf("%4d ", output_buffer[ 16 * y + x ] );
        }
        printf("\n");
    }

    size_t size;
    mameBitmap_encodeToFile( output_buffer, 1024 * 1024, "./out.pgm", context->info.width, context->info.height, MAMEBITMAP_FORMAT_PGM_ASCII, 255, &size );


    //mameJpeg_dumpHeader( context );
}
